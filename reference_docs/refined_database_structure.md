# Refined Database Structure - Onetime Backend

This document outlines the simplified data models for the "onetime backend", designed specifically for managing an underground parking environment with 1:1 parking spot to charging station mapping.

## Overview

- **Scope**: Underground parking management.
- **Key entities**: Renters, Parking Spots, Charging Stations, Authorization Tokens (RFID), and Charging Sessions.
- **Roaming**: None (Closed system).

## Models

### 1. Renter

Represents the customer who rents a specific parking spot.

- **Table Name**: `renters`
- **Columns**:
  - `id` (Integer, PK): Unique identifier.
  - `name` (String): Full name of the renter.
  - `contact_email` (String): Contact email for notifications/admin.
  - `phone_number` (String, Optional): For urgent contact.
  - `is_active` (Boolean): If false, renter is disabled/past renter.
  - `created_at` (DateTime): Record creation timestamp.

### 2. ParkingSpot

Represents a physical parking space in the underground garage.

- **Table Name**: `parking_spots`
- **Columns**:
  - `id` (Integer, PK): Unique identifier.
  - `label` (String, Unique): Human readable label (e.g., "B2-104").
  - `floor_level` (String, Optional): Helper to locate the spot (e.g., "Level -2").
  - `renter_id` (Integer, FK -> `renters.id`, Nullable): The current renter assigned to this spot.
  - `charging_station_id` (String, FK -> `charging_stations.id`, Unique): The specific charger installed at this spot.

### 3. ChargingStation

Represents the physical OCPP charging hardware installed at a spot.

- **Table Name**: `charging_stations`
- **Columns**:
  - `id` (String, PK): The ChargePoint Identity (OCPP `chargePointId`).
  - `is_online` (Boolean): Current connection status.
  - `last_heartbeat` (DateTime): Timestamp of last OCPP Heartbeat.
  - `model` (String): Charge point model (from BootNotification).
  - `vendor` (String): Charge point vendor (from BootNotification).
  - `firmware_version` (String): Current firmware version.

### 4. AuthorizationToken (RFID Card)

Represents the authentication method (RFID card) issued to a renter.

- **Table Name**: `authorization_tokens`
- **Columns**:
  - `token` (String, PK): The ID Tag value (e.g., hex string from RFID).
  - `renter_id` (Integer, FK -> `renters.id`): The renter who owns this card.
  - `status` (Enum): `Accepted`, `Blocked`, `Expired` (maps to OCPP AuthorizationStatus).
  - `expiry_date` (DateTime, Optional): date when validity ends.
  - `description` (String, Optional): e.g. "Main Driver", "Spouse Card".

### 5. ChargingSession (Transaction)

Records a charging session.

- **Table Name**: `charging_sessions`
- **Columns**:
  - `id` (Integer, PK): Internal DB ID.
  - `transaction_id` (Integer, Unique): The TransactionId generated by the Charge Point (OCPP).
  - `station_id` (String, FK -> `charging_stations.id`): Where the session happened.
  - `token_id` (String, FK -> `authorization_tokens.token`): The tag used to authorize.
  - `start_time` (DateTime): Session start timestamp (from StartTransaction).
  - `end_time` (DateTime, Nullable): Session end timestamp (from StopTransaction).
  - `meter_start` (Integer): Energy meter at start (Wh).
  - `meter_stop` (Integer, Nullable): Energy meter at stop (Wh).
  - `total_energy_kwh` (Float): Computed consumption.
  - `stop_reason` (String): Reason for stopping (e.g., "Local", "Remote", "EVDisconnected").

### 6. StationConnector (Connector)

Represents a specific connector on a charging station, tracking its realtime status.

- **Table Name**: `station_connectors`
- **Columns**:
  - `station_id` (String, FK -> `charging_stations.id`): The parent station.
  - `connector_id` (Integer): The connector number (1-based, 0 is main controller).
  - `status` (Enum): Current OCPP status (Available, Preparing, Charging, SuspendedEV, Faulted, etc.).
  - `error_code` (String): Current error code (e.g. NoError, GroundFailure).
  - `last_updated` (DateTime): Timestamp of the last StatusNotification.

### 7. MeterReading (MeterValue)

Stores distinct meter readings associated with a transaction.

- **Table Name**: `meter_readings`
- **Columns**:
  - `id` (Integer, PK): DB ID.
  - `transaction_id` (Integer, FK -> `charging_sessions.transaction_id`): The session this reading belongs to.
  - `timestamp` (DateTime): When the reading was sampled.
  - `measurand` (String): The type of measurement (e.g., `Energy.Active.Import.Register`, `Power.Active.Import`).
  - `value` (Float/String): The value itself.
  - `unit` (String): Unit of measure (e.g., `Wh`, `W`, `A`, `V`).
  - `phase` (String, Optional): Phase info (e.g., `L1`, `L1-N`).
  - `context` (String, Optional): Context (e.g., `Sample.Periodic`, `Transaction.End`).

### 8. StationConfiguration

Stores the configuration keys reported by the station.

- **Table Name**: `station_configurations`
- **Columns**:
  - `station_id` (String, FK -> `charging_stations.id`): The station.
  - `key` (String): The configuration key name (e.g., `HeartbeatInterval`).
  - `value` (String): The stored value.
  - `readonly` (Boolean): If the station reported it as read-only.

### 9. BootLog

A historical log of BootNotifications, useful for diagnosing firmware updates and reboots.

- **Table Name**: `boot_logs`
- **Columns**:
  - `id` (Integer, PK): DB ID.
  - `station_id` (String, FK -> `charging_stations.id`): The station that booted.
  - `boot_time` (DateTime): Server time of reception.
  - `model` (String): Reported chargePointModel.
  - `vendor` (String): Reported chargePointVendor.
  - `firmware_version` (String): Reported firmwareVersion.
  - `ip_address` (String, Optional): Source IP address of the request.

## Relationships & Logic

- **Authorization**: When a `Authorize` request comes in with a `idTag`:
  1. Lookup `AuthorizationToken` by `token`.
  2. If found and `status` == 'Accepted', return `Accepted`.
  3. Else return `Invalid`.
  *Note: Any renter can authorize at ANY station in the garage (per requirements).*

- **Tracking**:
  - `ChargingSession` links `token_id` (who) and `station_id` (where).
  - We can query "Where did Renter X charge?" by joining `rentals -> tokens -> sessions`.

- **Admin Management**:
  - New Renter: Create `Renter` record.
  - Assign Spot: Link `Renter` to `ParkingSpot`.
  - Issue Card: Create `AuthorizationToken` linked to `Renter`.
